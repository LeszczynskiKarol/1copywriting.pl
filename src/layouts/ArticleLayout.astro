---
import BaseLayout from './BaseLayout.astro';
import Breadcrumbs from '@/components/Breadcrumbs.astro';
import TableOfContents from '@/components/TableOfContents.astro';
import Newsletter from '@/components/Newsletter.astro';
import PromoBanner from '@/components/PromoBanner.astro';
import { SITE } from '@/utils/config';

interface Props {
  title: string;
  description: string;
  publishDate: Date;
  updatedDate?: Date;
  author?: string;
  category: string;
  silo: string;
  keyword: string;
  tags?: string[];
  image?: string;
  imageAlt?: string;
  readingTime?: number;
  headings: { depth: number; slug: string; text: string }[];
}

const {
  title,
  description,
  publishDate,
  updatedDate,
  author = 'Redakcja 1copywriting.pl',
  category,
  silo,
  keyword,
  tags = [],
  image,
  imageAlt,
  readingTime,
  headings,
} = Astro.props;

const formattedDate = new Intl.DateTimeFormat('pl-PL', {
  day: 'numeric',
  month: 'long',
  year: 'numeric',
}).format(publishDate);

const formattedUpdate = updatedDate
  ? new Intl.DateTimeFormat('pl-PL', {
      day: 'numeric',
      month: 'long',
      year: 'numeric',
    }).format(updatedDate)
  : null;

const canonicalURL = new URL(Astro.url.pathname, SITE.url).href;

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  description,
  image: image ? new URL(image, SITE.url).href : undefined,
  datePublished: publishDate.toISOString(),
  dateModified: (updatedDate || publishDate).toISOString(),
  author: {
    '@type': 'Person',
    name: author,
  },
  publisher: {
    '@type': 'Organization',
    name: SITE.title,
    url: SITE.url,
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalURL,
  },
  keywords: [keyword, ...tags].join(', '),
};

const breadcrumbs = [
  { label: 'Strona główna', href: '/' },
  { label: category, href: `/${silo}/` },
  { label: title },
];
---

<BaseLayout
  title={title}
  description={description}
  image={image}
  type="article"
  publishDate={publishDate}
  updatedDate={updatedDate}
  schema={articleSchema}
>
  <article class="article">
    <div class="container">
      <Breadcrumbs items={breadcrumbs} />

      <header class="article__header">
        <div class="article__meta-top">
          <a href={`/${silo}/`} class="article__category">{category}</a>
          {readingTime && <span class="article__reading-time">{readingTime} min czytania</span>}
        </div>
        <h1 class="article__title">{title}</h1>
        <p class="article__lead">{description}</p>
        <div class="article__meta-bottom">
          <span class="article__author">{author}</span>
          <span class="article__date-sep">·</span>
          <time datetime={publishDate.toISOString()}>{formattedDate}</time>
          {formattedUpdate && (
            <>
              <span class="article__date-sep">·</span>
              <span>Aktualizacja: {formattedUpdate}</span>
            </>
          )}
        </div>
      </header>

      {image && (
        <figure class="article__hero">
          <img
            src={image}
            alt={imageAlt || title}
            class="article__hero-img"
            loading="eager"
            decoding="async"
          />
          {imageAlt && imageAlt !== title && (
            <figcaption class="article__hero-caption">{imageAlt}</figcaption>
          )}
        </figure>
      )}

      <div class="article__body">
        <div class="article__content prose">
          <TableOfContents headings={headings} />
          <slot />
        </div>

        <!-- Sidebar: the outer div is the grid cell (full height),
             the inner div gets JS-driven position:fixed -->
        <aside class="article__sidebar" id="js-sidebar-track">
          <div class="article__sidebar-inner" id="js-sidebar-sticky">
            <PromoBanner />

            {tags.length > 0 && (
              <div class="article__tags">
                <h4 class="article__sidebar-title">Tagi</h4>
                <div class="article__tag-list">
                  {tags.map((tag) => (
                    <span class="article__tag">{tag}</span>
                  ))}
                </div>
              </div>
            )}
          </div>
        </aside>
      </div>

      <div class="article__footer">
        <Newsletter variant="inline" />
      </div>
    </div>
  </article>
</BaseLayout>

<!-- ============================================
     JS-POWERED STICKY SIDEBAR
     Uses position:fixed — works regardless of
     overflow:hidden on ANY ancestor element.
     ============================================ -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const track = document.getElementById('js-sidebar-track') as HTMLElement;
    const panel = document.getElementById('js-sidebar-sticky') as HTMLElement;
    if (!track || !panel) return;

    // Only activate on wide screens where sidebar is visible
    const MQ = window.matchMedia('(min-width: 1100px)');

    const TOP_GAP = 96; // header (72) + breathing room (24)

    function reset() {
      panel.style.position = '';
      panel.style.top = '';
      panel.style.bottom = '';
      panel.style.left = '';
      panel.style.width = '';
    }

    function update() {
      if (!MQ.matches) { reset(); return; }

      const trackRect = track.getBoundingClientRect();
      const panelH = panel.offsetHeight;
      const trackW = track.offsetWidth;

      // 1) Track hasn't scrolled into sticky zone yet → static
      if (trackRect.top >= TOP_GAP) {
        panel.style.position = 'relative';
        panel.style.top = '0';
        panel.style.bottom = '';
        panel.style.left = '';
        panel.style.width = '';
        return;
      }

      // 2) Track bottom is close → anchor panel to bottom of track
      if (trackRect.bottom <= panelH + TOP_GAP) {
        panel.style.position = 'absolute';
        panel.style.top = 'auto';
        panel.style.bottom = '0';
        panel.style.left = '0';
        panel.style.width = trackW + 'px';
        return;
      }

      // 3) Otherwise → fixed to viewport
      panel.style.position = 'fixed';
      panel.style.top = TOP_GAP + 'px';
      panel.style.bottom = '';
      panel.style.left = trackRect.left + 'px';
      panel.style.width = trackW + 'px';
    }

    // The track must be position:relative for the absolute fallback
    track.style.position = 'relative';

    window.addEventListener('scroll', update, { passive: true });
    window.addEventListener('resize', () => { reset(); update(); }, { passive: true });
    MQ.addEventListener('change', () => { reset(); update(); });

    update();
  });
</script>

<style>
  .article {
    padding-top: var(--space-2xl);
    padding-bottom: var(--space-4xl);
  }

  /* ===== HEADER ===== */
  .article__header {
    max-width: var(--max-content);
    margin-bottom: var(--space-2xl);
  }

  .article__meta-top {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
  }

  .article__category {
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--color-accent);
    text-decoration: none;
  }

  .article__category:hover {
    text-decoration: underline;
  }

  .article__reading-time {
    font-size: var(--text-xs);
    color: var(--color-ink-subtle);
  }

  .article__title {
    font-size: var(--text-4xl);
    line-height: 1.1;
    margin-bottom: var(--space-lg);
    max-width: 18ch;
  }

  .article__lead {
    font-size: var(--text-lg);
    color: var(--color-ink-muted);
    line-height: var(--leading-relaxed);
    max-width: 60ch;
  }

  .article__meta-bottom {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--text-sm);
    color: var(--color-ink-subtle);
    margin-top: var(--space-xl);
    padding-top: var(--space-xl);
    border-top: 1px solid var(--color-border-light);
  }

  .article__author {
    font-weight: 500;
    color: var(--color-ink-light);
  }

  /* ===== HERO IMAGE ===== */
  .article__hero {
    max-width: var(--max-wide);
    margin-bottom: var(--space-3xl);
  }

  .article__hero-img {
    width: 100%;
    aspect-ratio: 21/9;
    object-fit: cover;
    border-radius: var(--radius-xl);
  }

  .article__hero-caption {
    margin-top: var(--space-sm);
    font-size: var(--text-xs);
    color: var(--color-ink-subtle);
    text-align: center;
    font-style: italic;
  }

  /* ===== BODY GRID ===== */
  .article__body {
    display: grid;
    grid-template-columns: minmax(0, var(--max-content)) 280px;
    gap: var(--space-3xl);
  }

  /* Sidebar: let grid stretch it to full content height.
     Do NOT set align-self:start — we need the full height
     so the JS can position the inner panel correctly. */
  .article__sidebar {
    display: none;
  }

  .article__sidebar-inner {
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
    /* z-index so it stays above content when fixed */
    z-index: 10;
  }

  /* Tags */
  .article__sidebar-title {
    font-family: var(--font-body);
    font-weight: 600;
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--color-ink-subtle);
    margin-bottom: var(--space-md);
  }

  .article__tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }

  .article__tag {
    display: inline-block;
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--text-xs);
    background: var(--color-paper-alt);
    color: var(--color-ink-muted);
    border-radius: var(--radius-full);
    border: 1px solid var(--color-border-light);
  }

  /* ===== FOOTER ===== */
  .article__footer {
    max-width: var(--max-content);
    margin-top: var(--space-4xl);
  }

  /* ===== RESPONSIVE ===== */
  @media (min-width: 1100px) {
    .article__sidebar {
      display: block;
    }
  }

  @media (max-width: 1099px) {
    .article__body {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .article__title {
      font-size: var(--text-3xl);
    }

    .article__hero-img {
      aspect-ratio: 16/9;
      border-radius: var(--radius-lg);
    }
  }
</style>