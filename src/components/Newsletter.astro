---
/**
 * Newsletter.astro
 * Newsletter signup form with API Gateway backend
 * Variants: inline, banner, sidebar
 */

interface Props {
  variant?: 'inline' | 'banner' | 'sidebar';
}

const { variant = 'inline' } = Astro.props;

// API endpoint - update after running setup-newsletter-aws.sh
const API_ENDPOINT = 'https://YOUR_API_ID.execute-api.eu-central-1.amazonaws.com/prod';
---

<div class={`newsletter newsletter--${variant}`} data-newsletter>
  {variant === 'banner' && (
    <div class="newsletter__inner">
      <div class="newsletter__content">
        <span class="newsletter__badge">Newsletter</span>
        <h2 class="newsletter__title">Copywriting prosto do skrzynki</h2>
        <p class="newsletter__desc">
          Praktyczne porady, sprawdzone techniki i&nbsp;inspiracje ‚Äî co&nbsp;tydzie≈Ñ. 
          Do≈ÇƒÖcz do&nbsp;copywriter√≥w, kt√≥rzy chcƒÖ pisaƒá lepiej.
        </p>
      </div>
      <form class="newsletter__form" data-newsletter-form>
        <div class="newsletter__inputs">
          <input 
            type="email" 
            name="email" 
            placeholder="Tw√≥j email" 
            required 
            class="newsletter__input"
          />
          <button type="submit" class="newsletter__btn">
            <span class="newsletter__btn-text">Zapisz siƒô</span>
            <span class="newsletter__btn-loading">
              <svg class="newsletter__spinner" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" opacity="0.3"/>
                <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
              </svg>
            </span>
          </button>
        </div>
        <p class="newsletter__message" data-newsletter-message></p>
        <p class="newsletter__privacy">
          ZapisujƒÖc siƒô, akceptujesz naszƒÖ <a href="/polityka-prywatnosci/">politykƒô prywatno≈õci</a>.
          Mo≈ºesz wypisaƒá siƒô w ka≈ºdej chwili.
        </p>
      </form>
    </div>
  )}

  {variant === 'inline' && (
    <div class="newsletter__box">
      <h3 class="newsletter__box-title">üì¨ Newsletter</h3>
      <p class="newsletter__box-desc">Porady copywriterskie co tydzie≈Ñ.</p>
      <form class="newsletter__form newsletter__form--stacked" data-newsletter-form>
        <input 
          type="email" 
          name="email" 
          placeholder="Tw√≥j email" 
          required 
          class="newsletter__input"
        />
        <button type="submit" class="newsletter__btn newsletter__btn--full">
          <span class="newsletter__btn-text">Zapisz siƒô</span>
          <span class="newsletter__btn-loading">
            <svg class="newsletter__spinner" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" opacity="0.3"/>
              <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
            </svg>
          </span>
        </button>
        <p class="newsletter__message" data-newsletter-message></p>
      </form>
    </div>
  )}

  {variant === 'sidebar' && (
    <div class="newsletter__sidebar">
      <div class="newsletter__sidebar-icon">‚úâÔ∏è</div>
      <h4 class="newsletter__sidebar-title">Newsletter</h4>
      <p class="newsletter__sidebar-desc">Porady o copywritingu co tydzie≈Ñ.</p>
      <form class="newsletter__form newsletter__form--stacked" data-newsletter-form>
        <input 
          type="email" 
          name="email" 
          placeholder="Tw√≥j email" 
          required 
          class="newsletter__input newsletter__input--sm"
        />
        <button type="submit" class="newsletter__btn newsletter__btn--sm newsletter__btn--full">
          <span class="newsletter__btn-text">Zapisujƒô siƒô</span>
          <span class="newsletter__btn-loading">
            <svg class="newsletter__spinner" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" opacity="0.3"/>
              <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
            </svg>
          </span>
        </button>
        <p class="newsletter__message newsletter__message--sm" data-newsletter-message></p>
      </form>
    </div>
  )}
</div>

<script define:vars={{ API_ENDPOINT }}>
  document.querySelectorAll('[data-newsletter-form]').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = form.querySelector('.newsletter__btn');
      const message = form.querySelector('[data-newsletter-message]');
      const emailInput = form.querySelector('input[name="email"]');
      
      // Loading state
      btn.disabled = true;
      btn.classList.add('newsletter__btn--loading');
      message.textContent = '';
      message.className = 'newsletter__message';
      
      try {
        const response = await fetch(`${API_ENDPOINT}/subscribe`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: emailInput.value }),
        });
        
        const data = await response.json();
        
        if (response.ok) {
          message.textContent = data.message || 'Sprawd≈∫ email i potwierd≈∫ zapis!';
          message.classList.add('newsletter__message--success');
          emailInput.value = '';
        } else {
          message.textContent = data.error || 'WystƒÖpi≈Ç b≈ÇƒÖd. Spr√≥buj ponownie.';
          message.classList.add('newsletter__message--error');
        }
      } catch (error) {
        message.textContent = 'B≈ÇƒÖd po≈ÇƒÖczenia. Spr√≥buj ponownie.';
        message.classList.add('newsletter__message--error');
      } finally {
        btn.disabled = false;
        btn.classList.remove('newsletter__btn--loading');
      }
    });
  });
</script>

<style>
  /* ===== BANNER VARIANT ===== */
  .newsletter--banner {
    background: linear-gradient(135deg, var(--color-paper-warm) 0%, var(--color-paper-alt) 100%);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-xl);
    padding: var(--space-3xl);
  }

  .newsletter__inner {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-3xl);
    align-items: center;
  }

  .newsletter__badge {
    display: inline-block;
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-accent);
    background: var(--color-accent-light);
    padding: var(--space-xs) var(--space-md);
    border-radius: var(--radius-full);
    margin-bottom: var(--space-md);
  }

  .newsletter__title {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    margin-bottom: var(--space-sm);
  }

  .newsletter__desc {
    color: var(--color-ink-muted);
    line-height: var(--leading-relaxed);
    margin-bottom: 0;
  }

  .newsletter__form {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .newsletter__inputs {
    display: flex;
    gap: var(--space-sm);
  }

  .newsletter__input {
    flex: 1;
    padding: var(--space-md) var(--space-lg);
    font-family: var(--font-body);
    font-size: var(--text-base);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: white;
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
  }

  .newsletter__input:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px var(--color-accent-light);
  }

  .newsletter__input--sm {
    padding: var(--space-sm) var(--space-md);
    font-size: var(--text-sm);
  }

  .newsletter__btn {
    position: relative;
    padding: var(--space-md) var(--space-xl);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: 600;
    color: white;
    background: var(--color-accent);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: background var(--transition-fast), transform var(--transition-fast);
    white-space: nowrap;
  }

  .newsletter__btn:hover:not(:disabled) {
    background: var(--color-accent-hover);
    transform: translateY(-1px);
  }

  .newsletter__btn:disabled {
    cursor: not-allowed;
    opacity: 0.8;
  }

  .newsletter__btn--sm {
    padding: var(--space-sm) var(--space-md);
  }

  .newsletter__btn--full {
    width: 100%;
  }

  .newsletter__btn-loading {
    display: none;
  }

  .newsletter__btn--loading .newsletter__btn-text {
    visibility: hidden;
  }

  .newsletter__btn--loading .newsletter__btn-loading {
    display: flex;
    position: absolute;
    inset: 0;
    align-items: center;
    justify-content: center;
  }

  .newsletter__spinner {
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .newsletter__message {
    font-size: var(--text-sm);
    min-height: 1.5em;
    margin: 0;
  }

  .newsletter__message--sm {
    font-size: var(--text-xs);
  }

  .newsletter__message--success {
    color: #059669;
  }

  .newsletter__message--error {
    color: #dc2626;
  }

  .newsletter__privacy {
    font-size: var(--text-xs);
    color: var(--color-ink-subtle);
    margin: 0;
  }

  .newsletter__privacy a {
    color: var(--color-accent);
    text-decoration: underline;
  }

  /* ===== INLINE VARIANT ===== */
  .newsletter--inline .newsletter__box {
    background: var(--color-paper-alt);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
  }

  .newsletter__box-title {
    font-size: var(--text-lg);
    margin-bottom: var(--space-xs);
  }

  .newsletter__box-desc {
    font-size: var(--text-sm);
    color: var(--color-ink-muted);
    margin-bottom: var(--space-lg);
  }

  .newsletter__form--stacked {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  /* ===== SIDEBAR VARIANT ===== */
  .newsletter__sidebar {
    background: linear-gradient(135deg, var(--color-accent-light) 0%, #fff7ed 100%);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    text-align: center;
  }

  .newsletter__sidebar-icon {
    font-size: var(--text-3xl);
    margin-bottom: var(--space-sm);
  }

  .newsletter__sidebar-title {
    font-size: var(--text-base);
    font-weight: 600;
    margin-bottom: var(--space-xs);
  }

  .newsletter__sidebar-desc {
    font-size: var(--text-sm);
    color: var(--color-ink-muted);
    margin-bottom: var(--space-md);
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    .newsletter--banner {
      padding: var(--space-2xl);
    }

    .newsletter__inner {
      grid-template-columns: 1fr;
      gap: var(--space-xl);
    }

    .newsletter__inputs {
      flex-direction: column;
    }

    .newsletter__btn {
      width: 100%;
    }
  }
</style>
