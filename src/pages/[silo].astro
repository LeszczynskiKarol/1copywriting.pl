---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Breadcrumbs from '@/components/Breadcrumbs.astro';
import ArticleCard from '@/components/ArticleCard.astro';
import Newsletter from '@/components/Newsletter.astro';
import PromoSection from '@/components/PromoSection.astro';
import { SILOS, SITE } from '@/utils/config';

export async function getStaticPaths() {
  const posts = await getCollection('blog');

  return SILOS.map((silo) => {
    const siloArticles = posts
      .filter((post) => post.data.silo === silo.slug)
      .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

    return {
      params: { silo: silo.slug },
      props: { silo, articles: siloArticles },
    };
  });
}

const { silo, articles } = Astro.props;

// Find pillar article (the one matching the silo slug or marked as pillar)
const pillarArticle = articles.find(
  (post) => post.slug === silo.slug
);

const regularArticles = articles.filter(
  (post) => post.slug !== pillarArticle?.slug
);

const breadcrumbs = [
  { label: 'Strona g≈Ç√≥wna', href: '/' },
  { label: silo.title },
];

const categorySchema = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: silo.title,
  description: silo.description,
  url: `${SITE.url}/${silo.slug}/`,
  isPartOf: {
    '@type': 'WebSite',
    name: SITE.title,
    url: SITE.url,
  },
};
---

<BaseLayout
  title={`${silo.title} ‚Äî Przewodnik`}
  description={silo.description}
  schema={categorySchema}
>
  <section class="silo-page">
    <div class="container">
      <Breadcrumbs items={breadcrumbs} />

      <header class="silo-page__header">
        <div class="silo-page__icon" style={`--silo-color: ${silo.color}`}>
          {silo.icon}
        </div>
        <h1 class="silo-page__title">{silo.title}</h1>
        <p class="silo-page__desc">{silo.description}</p>
        <span class="silo-page__count">
          {articles.length} {articles.length === 1 ? 'artyku≈Ç' : articles.length < 5 ? 'artyku≈Çy' : 'artyku≈Ç√≥w'}
        </span>
      </header>

      {/* Pillar article ‚Äî highlighted at top */}
      {pillarArticle && (
        <div class="silo-page__pillar">
          <span class="silo-page__pillar-badge">üìñ Zacznij tutaj</span>
          <ArticleCard
            title={pillarArticle.data.title}
            description={pillarArticle.data.description}
            href={`/blog/${pillarArticle.slug}/`}
            category={silo.title}
            date={pillarArticle.data.publishDate}
            readingTime={pillarArticle.data.readingTime}
            image={pillarArticle.data.image}
            imageAlt={pillarArticle.data.imageAlt}
            featured={true}
          />
        </div>
      )}

      {regularArticles.length > 0 ? (
        <div class="silo-page__grid">
          {regularArticles.map((post) => (
            <ArticleCard
              title={post.data.title}
              description={post.data.description}
              href={`/blog/${post.slug}/`}
              category={silo.title}
              date={post.data.publishDate}
              readingTime={post.data.readingTime}
              image={post.data.image}
              imageAlt={post.data.imageAlt}
            />
          ))}
        </div>
      ) : !pillarArticle ? (
        <div class="silo-page__empty">
          <div class="silo-page__empty-icon" aria-hidden="true">‚úçÔ∏è</div>
          <h2 class="silo-page__empty-title">Tre≈õci w przygotowaniu</h2>
          <p class="silo-page__empty-desc">
            Pracujemy nad artyku≈Çami w&nbsp;tej kategorii.
            Zapisz siƒô na newsletter, ≈ºeby nie przegapiƒá publikacji.
          </p>
        </div>
      ) : null}
    </div>
  </section>

  <!-- SMART-COPY.AI PROMO -->
  <PromoSection variant="compact" />

  <section class="silo-page__footer">
    <div class="container">
      <Newsletter variant="inline" />
    </div>
  </section>
</BaseLayout>

<style>
  .silo-page {
    padding: var(--space-2xl) 0 var(--space-4xl);
  }

  .silo-page__header {
    margin-bottom: var(--space-3xl);
    max-width: var(--max-content);
  }

  .silo-page__icon {
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    background: color-mix(in srgb, var(--silo-color) 10%, transparent);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-xl);
  }

  .silo-page__title {
    font-size: var(--text-4xl);
    margin-bottom: var(--space-md);
  }

  .silo-page__desc {
    font-size: var(--text-lg);
    color: var(--color-ink-muted);
    line-height: var(--leading-relaxed);
    max-width: 55ch;
    margin-bottom: var(--space-sm);
  }

  .silo-page__count {
    display: inline-block;
    font-size: var(--text-sm);
    color: var(--color-ink-subtle);
    font-weight: 500;
  }

  /* Pillar highlight */
  .silo-page__pillar {
    margin-bottom: var(--space-2xl);
    padding-bottom: var(--space-2xl);
    border-bottom: 1px solid var(--color-border-light);
  }

  .silo-page__pillar-badge {
    display: inline-block;
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-accent);
    margin-bottom: var(--space-md);
  }

  .silo-page__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-lg);
  }

  .silo-page__empty {
    text-align: center;
    padding: var(--space-4xl) var(--space-xl);
    background: var(--color-paper-warm);
    border: 1px dashed var(--color-border);
    border-radius: var(--radius-xl);
  }

  .silo-page__empty-icon {
    font-size: 3rem;
    margin-bottom: var(--space-lg);
  }

  .silo-page__empty-title {
    font-size: var(--text-2xl);
    margin-bottom: var(--space-md);
  }

  .silo-page__empty-desc {
    color: var(--color-ink-muted);
    max-width: 40ch;
    margin-inline: auto;
  }

  .silo-page__footer {
    padding: var(--space-4xl) 0;
  }

  .silo-page__footer .container {
    max-width: var(--max-content);
  }

  @media (max-width: 768px) {
    .silo-page__grid {
      grid-template-columns: 1fr;
    }
  }
</style>